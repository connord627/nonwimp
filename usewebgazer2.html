<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
<TITLE>WebGazer Game</TITLE>

<!-- <script src="https://webgazer.cs.brown.edu/webgazer.js"> </script> -->

<script src="webgazer.js"></script>
<script>
/*
 * Bare bones program that uses WebGazer.js
 *
 * Based on https://webgazer.cs.brown.edu/demo.html by Jeff Huang
 *
 * Must run on a remote server, and access via https not http. 
 * Must download webgazer.js from http://webgazer.cs.brown.edu and put it where above 'script src=' statement will find it. 
 * Can ignore alert box that complains about webGL. 
 */

function inTarget (data) { 
    // Weird offset determined empirically, other dimensions match our HTML
    let xoffset = 350
    for (i = 0; i < enemylist.length; i++){
        //Offset is working, but this statement is not firing for some reason
        if (data && data.x > enemylist[i].getX()+xoffset && data.x < enemylist[i].getX()+xoffset+35 && data.y > enemylist[i].getY && data.y < enemylist[i].getY()+35){
            console.log("Hit a box")
        }
    }
    return data && data.x > 400+xoffset && data.x < 400+xoffset+100 && data.y > 300 && data.y < 300+100
}

enemylist = [];
var intervalId

//Creates new enemies and puts them into the enemy list
function spawnEnemies(numenemies) {
    for (i = 0; i < numenemies; i++) {
        newenemy = new Enemy()
        enemylist.push(newenemy)
    }
}

//Deletes the first n number of enemies from the list
function deleteEnemies(numenemies) {
    enemylist.splice(0, numenemies)
}

//Clears the whole screen for redrawing
function Clear(){
	var canvas = document.getElementById("canvas")
	var ctx = canvas.getContext("2d");
	
	ctx.clearRect(0,0,1000,1000);
}

//Draws all of the enemies in the enemy list
function drawEnemies() {
    Clear();

    for (i = 0; i < enemylist.length; i++) {
        var canvas = document.getElementById("canvas")
	    var context = canvas.getContext("2d");
        context.fillRect(enemylist[i].getX(), enemylist[i].getY(), 35, 35);
    }
}

/*
Enemy class: 
x = x coordinate on canvas
y = y coordinate on canvas
*/
class Enemy {
    constructor(){
        this.x = Math.floor(Math.random() * 800);
        this.y = Math.floor(Math.random() * 800);
    }

    getX() {
        return this.x
    }

    getY() {
        return this.y
    }
}

/*
 * Called whenever we get new gaze data
 * data = object containing an x and y key which are the x and y prediction coordinates (no bounds limiting)
 * clock = elapsed time in milliseconds since webgazer.begin() was called
 */
var lastHit = 0
function gaze (data, clock) { 
    const delay = 400 // ms

    if (data==null) return;

    let target = document.getElementById("target1")

    if (inTarget (data)) { 
        //console.log("In target")
        target.style.color = "red" 
	target.style.background = "black" 

	lastHit = clock 
    }
    else {
	// Time delay is just so user will notice the color change
	if (clock-lastHit > delay) { 
	    target.style.color = "black" 
	    target.style.background = "white" 
	}
    }
}

window.onload = function() {
    var canvas = document.getElementById('canvas');
    webgazer.setGazeListener(gaze) 
	.begin() 
    //Put a calibrate function here
    //create the variable outside the function
    intervalId = window.setInterval(function(){
        //These are what we can change depending on difficulty
        spawnEnemies(2)
        deleteEnemies(1)
        drawEnemies()
        //can also change the number of milliseconds below
    }, 5000);
};

function reset() {
    deleteEnemies(enemylist.length)
    drawEnemies()
}

function pause() {
    var btn = document.getElementById("pause")
    if (btn.value == "Pause") {
        btn.value = "Unpause"
        clearInterval(intervalId)
    }
    else {
        btn.value = "Pause"
        intervalId = window.setInterval(function(){
        spawnEnemies(2)
        deleteEnemies(1)
        drawEnemies()
    }, 5000);
    }
}

function buttonPressed (str) {
    if (str == "reset") {
        reset()
    }
    else if (str == "pause") {
        pause()
    }
}


</script>
</head>

<BODY LANG="en-US" LINK="#0000ff" DIR="LTR">




    <canvas id="canvas" width="1000" height="1000"></canvas>
    <div id="target1" style="position:absolute; border-style:solid; border-color:red; right:400px; top:300px; height:100px; width:100px">
	<h2>Try me!</h2>
    </div>

    <br>

    <input type=button value="Reset"
	onclick="buttonPressed('reset')">

    <input type=button id="pause" value="Pause"
	onclick="buttonPressed('pause')">

    <label for="html">Score: </label>

</BODY>
</HTML>